<?php

/**
 * @file
 * Stress tests for the Host module
 *
 *
 * NOTE: This has been autogenerated.
 * 
 */

class ThumbWhereHostStressTestCase extends DrupalWebTestCase {

  protected $privileged_user;

  public function getInfo() {
    return array(
        'name' => 'Host Entity Stress Test',
        'description' => 'Creates Hosts in lots of 10, 100(disabled), 1000(disabled) and outputs the times take and the average rate of creation.',
        'group' => 'ThumbWhereStress',
    );
  }

  public function setUp() {

    // Make sure we are using the testing profile
    $this->profile = 'testing';
    
    // We need temporary folder
    static $temporary_directory;
    $temporary_directory = 'C:\\TEMP\\';    

    // Set the critial thumbwhere config 
    variable_set('thumbwhere_api_url', 'localhost.thumbwhere.com');
    variable_set('thumbwhere_api_version', 'v1.1');
    variable_set('thumbwhere_api_key', '80bb71a1-131c-43c2-9bac-e27006051cd0');
    variable_set('thumbwhere_master_console', '0');
    variable_set('thumbwhere_api_log_debug', '0');
    variable_set('thumbwhere_api_log_trace', '0');
    variable_set('thumbwhere_machine_id', 1);    

    // Enable the module.
    parent::setUp('thumbwhere_host');
    	
    	

    $this->privileged_user = $this->drupalCreateUser(array());
    $this->drupalLogin($this->privileged_user);
  }

  /**
   * Create 100 contents..
   */
  function testStress100() {

    // Set the critial thumbwhere config 
    variable_set('thumbwhere_api_url', 'localhost.thumbwhere.com');
    variable_set('thumbwhere_api_version', 'v1.1');
    variable_set('thumbwhere_api_key', '80bb71a1-131c-43c2-9bac-e27006051cd0');
    variable_set('thumbwhere_master_console', '0');
    variable_set('thumbwhere_api_log_debug', '0');
    variable_set('thumbwhere_api_log_trace', '0');
    variable_set('thumbwhere_machine_id', 1);    


    $n = 100;

    $time_start = microtime(TRUE);
    
    $total = 0;
   

    for ($i = 0; $i < $n; $i++) {

      $entity = _thumbwhere_stresstest_create_Host($this->privileged_user->uid,$this);
	
      if ($entity == null) {
        break;
      }
	  

      $entity->save($transaction);
      
      $total++;

    }
    
    if ($total < $n)
    {
    	$this->assertTrue(TRUE, 'Bailed because we can not create dependencies.');
    	return;
    }

    $time_end = microtime(TRUE);
    $time = $time_end - $time_start;

    $result = TRUE;
    $message = t("Created $total Hosts in $time seconds = " . $total / $time . ' contents per second.');

    if (function_exists('drush_log')) {
      drush_log($message, 'metric');
      drush_log("##teamcity[buildStatisticValue key='hostCreate" . $total . "' value='" . $total / $time . "']");
    }
    
    $this->assertTrue($result, $message);



  }


 
}
     

function _thumbwhere_stresstest_create_Host($uid,$test) {

    global $_in_thumbwhere_stresstest_create_Host;
    $_in_thumbwhere_stresstest_create_Host = TRUE;
	
    //
    // Global values that we will use...
    //
    
    global $_global_thumbwhere_stresstest_HostType;
    if (!isset( $_global_thumbwhere_stresstest_HostType)){
      if (function_exists ('_thumbwhere_stresstest_create_HostType')) {
        $_global_thumbwhere_stresstest_HostType = _thumbwhere_stresstest_create_HostType($uid,$test);
      }
      else {
        debug('bailing - function \'_thumbwhere_stresstest_create_HostType\' is not loaded yet.');
        return NULL;
      }
    }
    global $_global_thumbwhere_stresstest_HostCredential;
    if (!isset( $_global_thumbwhere_stresstest_HostCredential)){
      if (function_exists ('_thumbwhere_stresstest_create_HostCredential')) {
        $_global_thumbwhere_stresstest_HostCredential = _thumbwhere_stresstest_create_HostCredential($uid,$test);
      }
      else {
        debug('bailing - function \'_thumbwhere_stresstest_create_HostCredential\' is not loaded yet.');
        return NULL;
      }
    }
          		
          		
    $entity = entity_create('thumbwhere_host', array(
        'uid' => $uid,
        'hosttype' => $_global_thumbwhere_stresstest_HostType,
        'hostcredential' => $_global_thumbwhere_stresstest_HostCredential,
    		'address' => $test->randomName(),

      ));  
      
    $_in_thumbwhere_stresstest_create_Host = FALSE;
    return $entity;
}
